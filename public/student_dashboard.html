<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Student Portal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- CORE THEME --- */
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; color: white; background: #000; display: flex; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 260px; background: #09090b; border-right: 1px solid #27272a;
            display: flex; flex-direction: column; padding: 25px; flex-shrink: 0;
            justify-content: space-between; height: 100%; box-sizing: border-box;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 100;
        }
        
        .brand { display: flex; align-items: center; gap: 12px; margin-bottom: 40px; font-size: 18px; font-weight: 700; letter-spacing: -0.5px; }
        
        /* PURPLE GRADIENT ICON */
        .app-icon { width: 32px; height: 32px; background: linear-gradient(135deg, #bf5af2, #5e5ce6); border-radius: 8px; display: grid; place-items: center; box-shadow: 0 4px 12px rgba(191, 90, 242, 0.3); }
        .app-icon svg { width: 18px; height: 18px; fill: white; }

        .nav-item { padding: 12px 15px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 12px; font-size: 14px; font-weight: 500; color: #a1a1aa; transition: 0.2s; margin-bottom: 5px;}
        .nav-item:hover { background: #18181b; color: white; }
        .nav-item.active { background: #27272a; color: white; }
        .nav-item svg { width: 20px; height: 20px; fill: currentColor; }
        
        /* --- GLASS MORPH LOGOUT --- */
        .logout-btn {
            margin-top: auto; padding: 14px 20px; border-radius: 16px; cursor: pointer;
            background: rgba(255, 69, 58, 0.08); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 69, 58, 0.2); color: #ff453a; font-weight: 600; font-size: 14px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .logout-btn:hover { background: #ff453a; color: white; border-color: transparent; box-shadow: 0 5px 25px rgba(255, 69, 58, 0.4); transform: translateY(-3px); }
        .logout-btn svg { width: 20px; height: 20px; fill: currentColor; }

        /* --- MAIN CONTENT --- */
        .main-content { flex: 1; overflow-y: auto; padding: 40px; position: relative; width: 100%; }
        
        .menu-btn { display: none; position: absolute; top: 20px; left: 20px; background: #1c1c1e; border: 1px solid #333; padding: 8px; border-radius: 8px; cursor: pointer; z-index: 50; }
        .menu-btn svg { width: 24px; height: 24px; fill: white; }
        .mobile-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); z-index: 90; }

        .top-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .page-title { margin: 0; font-size: 28px; font-weight: 700; letter-spacing: -0.5px; }

        /* --- NEW: TIMETABLE BUTTON --- */
        .btn-tt {
            background: linear-gradient(135deg, #bf5af2, #5e5ce6); /* Purple theme for students */
            color: white; border: none; padding: 10px 20px; border-radius: 20px;
            font-weight: 600; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 8px;
            box-shadow: 0 4px 15px rgba(191, 90, 242, 0.3); transition: 0.2s;
        }
        .btn-tt:hover { transform: scale(1.05); }

        /* --- PROGRESS CARD --- */
        .progress-card { background: #1c1c1e; padding: 30px; border-radius: 20px; margin-bottom: 30px; border: 1px solid #333; position: relative; overflow: hidden; }
        .progress-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 15px; }
        .big-percent { font-size: 48px; font-weight: 800; line-height: 1; }
        .progress-bar-bg { width: 100%; height: 8px; background: #333; border-radius: 4px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: #30d158; width: 0%; transition: width 1s ease; border-radius: 4px; }
        .danger-zone .progress-bar-fill { background: #ff453a; }
        .danger-zone .big-percent { color: #ff453a; }
        .safe-zone .big-percent { color: #30d158; }

        /* --- NEW: SUBJECT STATS (VISUAL UPGRADE) --- */
        .subject-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .subject-card {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .sub-name { font-size: 13px; font-weight: 600; color: #ccc; display: block; margin-bottom: 5px; }
        .sub-bar-bg { height: 6px; background: #333; border-radius: 3px; overflow: hidden; margin-top: 8px; }
        .sub-bar-fill { height: 100%; background: #bf5af2; border-radius: 3px; }
        .sub-stats { display: flex; justify-content: space-between; font-size: 11px; margin-top: 5px; color: #888; }

        /* --- NEW: INTERACTIVE CALENDAR --- */
        .calendar-container {
            background: #1c1c1e;
            padding: 25px;
            border-radius: 20px;
            border: 1px solid #333;
            margin-bottom: 30px;
        }
        .cal-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 15px;
        }
        .cal-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            border-radius: 8px;
            background: rgba(255,255,255,0.03);
            position: relative;
        }
        .cal-header { font-weight: bold; color: #888; background: transparent; }
        .cal-dot {
            width: 6px; height: 6px; border-radius: 50%;
            position: absolute; bottom: 4px;
        }
        .dot-green { background: #30d158; box-shadow: 0 0 5px #30d158; }
        .dot-red { background: #ff453a; box-shadow: 0 0 5px #ff453a; }
        
        /* --- NEW: "UP NEXT" WIDGET --- */
        .next-class-card {
            background: linear-gradient(135deg, #2c2c2e, #1c1c1e);
            padding: 20px; border-radius: 20px;
            border: 1px solid #444;
            display: flex; align-items: center; gap: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
        }
        .time-box {
            background: rgba(255,255,255,0.1);
            padding: 10px 15px;
            border-radius: 12px;
            text-align: center;
            min-width: 60px;
        }
        .time-box h4 { margin: 0; font-size: 18px; color: #fff; }
        .time-box span { font-size: 11px; color: #aaa; text-transform: uppercase; }

        /* --- NEW: PROFILE STYLES --- */
        .profile-container { display: flex; flex-direction: column; gap: 20px; max-width: 600px; }
        .profile-header { display: flex; align-items: center; gap: 20px; }
        .p-avatar { width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #bf5af2, #5e5ce6); display: grid; place-items: center; font-size: 32px; font-weight: bold; }
        .p-info h2 { margin: 0; font-size: 24px; }
        .p-info p { margin: 5px 0 0 0; color: #888; font-size: 14px; }
        .p-badge { background: rgba(191, 90, 242, 0.15); color: #bf5af2; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; display: inline-block; margin-top: 5px; }
        
        .p-details { background: #1c1c1e; border: 1px solid #333; border-radius: 16px; padding: 20px; margin-top: 20px; }
        .p-row { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #2c2c2e; }
        .p-row:last-child { border-bottom: none; }
        .p-label { color: #888; font-size: 14px; }
        .p-value { font-weight: 600; font-size: 14px; }

        /* --- INPUTS --- */
        .glass-input {
            width: 100%; box-sizing: border-box;
            background: #1c1c1e; border: 1px solid #2c2c2e; color: white; padding: 12px 15px; border-radius: 12px; outline: none; transition: 0.2s;
            font-family: inherit; font-size: 14px; margin-bottom: 15px;
        }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
        .glass-input:focus { border-color: #bf5af2; box-shadow: 0 0 0 3px rgba(191, 90, 242, 0.1); }
        
        .btn-apply { 
            width: 100%; background: #bf5af2; color: white; border: none; 
            padding: 12px; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 14px;
        }
        .btn-apply:hover { background: #ac4cdf; }

        /* --- TABLE --- */
        .table-wrap { background: #1c1c1e; border: 1px solid #2c2c2e; border-radius: 16px; overflow: hidden; overflow-x: auto; margin-top: 20px; }
        .row { display: flex; padding: 15px 25px; border-bottom: 1px solid #2c2c2e; align-items: center; min-width: 500px; }
        .row:hover { background: #27272a; }
        .row.header-row { background: #252528; border-bottom: 1px solid #333; }
        .row.header-row span { font-size: 12px; color: #8e8e93; font-weight: 600; text-transform: uppercase; }
        
        .col { flex: 1; font-size: 14px; color: #fff; }
        .col.end { text-align: right; }
        
        /* STATUS BADGES */
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; display: inline-block; }
        .status-Approved { background: rgba(48, 209, 88, 0.2); color: #30d158; }
        .status-Rejected { background: rgba(255, 69, 58, 0.2); color: #ff453a; }
        .status-Pending { background: rgba(255, 159, 10, 0.2); color: #ff9f0a; }

        /* TOASTS */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: rgba(28,28,30,0.9); backdrop-filter: blur(10px); border: 1px solid #333; color: white; padding: 12px 20px; border-radius: 12px; display: flex; align-items: center; gap: 10px; font-size: 14px; animation: slideIn 0.3s ease; }
        .toast.success { border-left: 4px solid #30d158; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .section { display: none; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- TIMETABLE MODAL STYLES --- */
        .tt-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 2000;
            justify-content: center; align-items: center; padding: 20px; box-sizing: border-box;
        }
        .tt-box {
            background: #1c1c1e; width: 100%; max-width: 900px; height: 80vh; 
            border-radius: 20px; border: 1px solid #333; display: flex; flex-direction: column; overflow: hidden;
        }
        .tt-header {
            padding: 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;
        }
        .tt-filters { display: flex; gap: 10px; }
        .tt-btn {
            background: transparent; border: 1px solid #444; color: #888; padding: 8px 16px; border-radius: 8px; cursor: pointer; transition: 0.2s;
        }
        .tt-btn.active { background: #bf5af2; color: white; border-color: #bf5af2; }
        .tt-close { cursor: pointer; color: #888; font-size: 24px; font-weight: bold; }
        .tt-close:hover { color: white; }
        
        .tt-body { flex: 1; overflow-y: auto; padding: 20px; }
        .tt-grid { width: 100%; border-collapse: collapse; color: white; font-size: 13px; }
        .tt-grid th, .tt-grid td { border: 1px solid #333; padding: 10px; text-align: center; }
        .tt-grid th { background: #2c2c2e; color: #aaa; text-transform: uppercase; font-size: 11px; }
        .tt-grid td { background: #000; }
        .tt-section-title { color: #bf5af2; margin-top: 30px; margin-bottom: 10px; font-size: 16px; font-weight: bold; }

        @media (max-width: 768px) {
            .sidebar { position: fixed; top: 0; left: 0; height: 100%; transform: translateX(-100%); width: 280px; box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
            .sidebar.open { transform: translateX(0); }
            .main-content { padding: 20px; padding-top: 70px; }
            .menu-btn { display: block; }
            .tt-header { flex-direction: column; gap: 15px; align-items: flex-start; }
            .tt-grid th, .tt-grid td { padding: 5px; font-size: 10px; }
        }
    </style>
</head>
<body>

    <div id="toast-container"></div>
    <div class="mobile-overlay" id="overlay" onclick="toggleMenu()"></div>
    <div class="menu-btn" onclick="toggleMenu()"><svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></div>

    <div class="sidebar" id="sidebar">
        <div>
            <div class="brand">
                <div class="app-icon"><svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></div>
                Student Portal
            </div>
            
            <div class="nav-group">
                <div class="nav-item active" onclick="switchTab('dashboard', this); toggleMenu()">
                    <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                    My Stats
                </div>
                <div class="nav-item" onclick="switchTab('apply', this); toggleMenu()">
                    <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 14H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
                    Apply Leave
                </div>
                <div class="nav-item" onclick="switchTab('profile', this); toggleMenu()">
                    <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                    My Profile
                </div>
            </div>
        </div>
        
        <div class="logout-btn" onclick="logout()">
            <svg viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
            Log Out
        </div>
    </div>

    <div class="main-content">
        <div class="top-header">
            <h1 class="page-title" id="pageTitle">My Stats</h1>
            <button class="btn-tt" onclick="openTimetable()">ðŸ“… View Time Table</button>
        </div>

        <div id="tab-dashboard" class="section active">
            <div class="next-class-card" id="nextClassWidget">
                <div class="time-box">
                    <h4 id="nextClassTime">--:--</h4>
                    <span>Starts In</span>
                </div>
                <div>
                    <h3 style="margin:0; font-size:18px;">Up Next: <span id="nextClassName" style="color:#bf5af2;">Loading...</span></h3>
                    <p style="margin:5px 0 0; font-size:13px; color:#888;">Stay prepared for your next session.</p>
                </div>
            </div>

            <div id="progressCard" class="progress-card safe-zone">
                <div class="progress-header">
                    <div>
                        <span style="color:#888; text-transform:uppercase; font-size:12px; font-weight:600; letter-spacing:1px;">Global Attendance</span>
                        <div class="big-percent" id="percentText">--%</div>
                    </div>
                    <div style="text-align:right;">
                        <span id="daysAttended" style="font-size:14px; color:#ccc;">0/0 Days</span>
                    </div>
                </div>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="progressBar"></div>
                </div>
                <p style="margin-top:15px; font-size:13px; color:#666;" id="statusMsg">Calculating...</p>
            </div>

            <h3 style="margin-bottom:15px; font-size:16px;">Subject Analytics</h3>
            <div class="subject-grid" id="subjectGrid">
                <p style="color:#666; font-size:13px;">Analyzing data...</p>
            </div>

            <h3 style="margin-bottom:15px; font-size:16px;">Activity Calendar</h3>
            <div class="calendar-container">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span id="calMonthYear" style="font-weight:bold; color:#fff;">January 2026</span>
                    <div style="display:flex; gap:10px;">
                        <span style="font-size:10px; color:#aaa;">ðŸŸ¢ Present</span>
                        <span style="font-size:10px; color:#aaa;">ðŸ”´ Absent</span>
                    </div>
                </div>
                <div class="cal-grid" id="calGrid"></div>
            </div>

            <h3 style="margin-bottom:15px; font-size:16px;">Full History</h3>
            <div class="table-wrap">
                <div class="row header-row">
                    <span class="col">Date & Period</span>
                    <span class="col end">Status</span>
                </div>
                <div id="historyList">
                    <p style="padding:20px; text-align:center; color:#666">Loading history...</p>
                </div>
            </div>
        </div>

        <div id="tab-apply" class="section">
            <div class="progress-card" style="border:1px solid #333;">
                <h3 style="margin-top:0;">Request Leave</h3>
                <input type="date" id="leaveDate" class="glass-input">
                <input type="text" id="leaveReason" class="glass-input" placeholder="Reason for leave (e.g. Sick, Family Event)">
                <button class="btn-apply" onclick="applyLeave()">Submit Request</button>
            </div>

            <h3 style="margin-bottom:15px; font-size:16px;">My Requests</h3>
            <div class="table-wrap">
                <div class="row header-row">
                    <span class="col">Date</span>
                    <span class="col">Reason</span>
                    <span class="col end">Status</span>
                </div>
                <div id="myLeaveList">
                    <p style="padding:20px; text-align:center; color:#666">No requests found.</p>
                </div>
            </div>
        </div>

        <div id="tab-profile" class="section">
            <div class="progress-card profile-container">
                <div class="profile-header">
                    <div class="p-avatar" id="sProfileInitial">S</div>
                    <div class="p-info">
                        <h2 id="sProfileName">Loading...</h2>
                        <span class="p-badge">Student</span>
                    </div>
                </div>
                <div class="p-details">
                    <div class="p-row">
                        <span class="p-label">Email</span>
                        <span class="p-value" id="sProfileEmail">...</span>
                    </div>
                    <div class="p-row">
                        <span class="p-label">Roll Number</span>
                        <span class="p-value" id="sProfileRoll">...</span>
                    </div>
                    <div class="p-row">
                        <span class="p-label">Year</span>
                        <span class="p-value" id="sProfileYear">...</span>
                    </div>
                    <div class="p-row">
                        <span class="p-label">Section</span>
                        <span class="p-value" id="sProfileSection">...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="tt-modal" id="ttModal">
        <div class="tt-box">
            <div class="tt-header">
                <div class="tt-filters">
                    <button class="tt-btn active" onclick="renderTimetable('1', this)">1st Year</button>
                    <button class="tt-btn" onclick="renderTimetable('2', this)">2nd Year</button>
                    <button class="tt-btn" onclick="renderTimetable('3', this)">3rd Year</button>
                    <button class="tt-btn" onclick="renderTimetable('4', this)">4th Year</button>
                </div>
                <div class="tt-close" onclick="closeTimetable()">âœ–</div>
            </div>
            <div class="tt-body" id="ttBody">
                </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="app.js"></script>
    <script>
        // --- UI UTILS ---
        document.getElementById('leaveDate').valueAsDate = new Date();

        function showToast(message) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast success`;
            toast.innerHTML = `<span>âœ”</span> ${message}`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
        }

        function toggleMenu() {
            if (window.innerWidth <= 768) {
                const sb = document.getElementById('sidebar');
                const ov = document.getElementById('overlay');
                if (sb.classList.contains('open')) { sb.classList.remove('open'); ov.style.display = 'none'; }
                else { sb.classList.add('open'); ov.style.display = 'block'; }
            }
        }

        function switchTab(tabName, el) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            
            // Set Titles
            let title = 'My Stats';
            if(tabName === 'apply') title = 'Apply Leave';
            if(tabName === 'profile') title = 'My Profile';
            document.getElementById('pageTitle').innerText = title;

            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
        }

        // --- FULL TIMETABLE DATA (SAME AS TEACHER) ---
        const timeTables = {
            "2": { "D": { 1: { "1": "DBMS", "2": "OS", "3": "SE", "4": "MEFA", "5": "OS-LAB", "6": "OS-LAB", "7": "OS-LAB" }, 2: { "1": "DTI", "2": "MEFA", "3": "DBMS", "4": "LIB", "5": "DBMS", "6": "PROJECT", "7": "PROJECT" }, 3: { "1": "MEFA", "2": "DBMS", "3": "OS", "4": "P&S", "5": "SE", "6": "SPORTS", "7": "SPORTS" }, 4: { "1": "OS", "2": "P&S", "3": "MEFA", "4": "SE", "5": "OS", "6": "DTI", "7": "DTI" }, 5: { "1": "P&S", "2": "OS", "3": "DBMS", "4": "FSD-1", "5": "DBMS-LAB", "6": "DBMS-LAB", "7": "DBMS-LAB" }, 6: { "1": "SE", "2": "P&S", "3": "FSD-1", "4": "FSD-1", "5": "TBS", "6": "SE", "7": "C/M" } }, "A": { 1: { "1": "OS", "2": "DBMS", "3": "P&S", "4": "DTI", "5": "SE", "6": "MEFA", "7": "LIB" }, 2: { "1": "SE", "2": "P&S", "3": "MEFA", "4": "OS", "5": "DTI", "6": "DBMS", "7": "SPORTS" }, 3: { "1": "DBMS", "2": "SE", "3": "DTI", "4": "MEFA", "5": "OS", "6": "P&S", "7": "PROJECT" }, 4: { "1": "P&S", "2": "DTI", "3": "OS", "4": "DBMS", "5": "MEFA", "6": "SE", "7": "LIB" }, 5: { "1": "MEFA", "2": "OS", "3": "SE", "4": "P&S", "5": "DBMS", "6": "DTI", "7": "COUN" }, 6: { "1": "DTI", "2": "MEFA", "3": "P&S", "4": "SE", "5": "OS", "6": "DBMS", "7": "SPORTS" } }, "B": { 1: { "1": "P&S", "2": "SE", "3": "OS", "4": "MEFA", "5": "DTI", "6": "DBMS", "7": "SPORTS" }, 2: { "1": "OS", "2": "DTI", "3": "P&S", "4": "SE", "5": "MEFA", "6": "LIB", "7": "DBMS" }, 3: { "1": "SE", "2": "MEFA", "3": "DBMS", "4": "OS", "5": "P&S", "6": "DTI", "7": "PROJECT" }, 4: { "1": "MEFA", "2": "DBMS", "3": "DTI", "4": "P&S", "5": "SE", "6": "OS", "7": "COUN" }, 5: { "1": "DTI", "2": "P&S", "3": "SE", "4": "DBMS", "5": "OS", "6": "MEFA", "7": "LIB" }, 6: { "1": "DBMS", "2": "OS", "3": "MEFA", "4": "DTI", "5": "P&S", "6": "SE", "7": "SPORTS" } }, "C": { 1: { "1": "SE", "2": "MEFA", "3": "DTI", "4": "DBMS", "5": "P&S", "6": "OS", "7": "LIB" }, 2: { "1": "MEFA", "2": "DBMS", "3": "OS", "4": "P&S", "5": "SE", "6": "DTI", "7": "SPORTS" }, 3: { "1": "OS", "2": "P&S", "3": "SE", "4": "DTI", "5": "DBMS", "6": "MEFA", "7": "PROJECT" }, 4: { "1": "DTI", "2": "OS", "3": "MEFA", "4": "SE", "5": "P&S", "6": "DBMS", "7": "COUN" }, 5: { "1": "DBMS", "2": "SE", "3": "P&S", "4": "MEFA", "5": "DTI", "6": "OS", "7": "LIB" }, 6: { "1": "P&S", "2": "DTI", "3": "DBMS", "4": "OS", "5": "MEFA", "6": "SE", "7": "SPORTS" } } },
            "1": { "D": { 1: { "1": "LA&C", "2": "IP", "3": "CHE", "4": "CHE LAB", "5": "CHE LAB", "6": "BCME", "7": "CE" }, 2: { "1": "BCME", "2": "IP", "3": "CE LAB", "4": "CE LAB", "5": "CE LAB", "6": "HC", "7": "LA&C" }, 3: { "1": "CE", "2": "IP", "3": "CHE", "4": "LA&C", "5": "BCME", "6": "CHE LAB", "7": "EW LAB" }, 4: { "1": "CHE", "2": "IP", "3": "CE", "4": "LA&C", "5": "BCME", "6": "CP LAB", "7": "CP LAB" }, 5: { "1": "CHE", "2": "IP", "3": "BCME", "4": "HWYS", "5": "LA&C", "6": "BCME", "7": "CE" }, 6: { "1": "CHE", "2": "IP", "3": "CHE", "4": "CHE", "5": "CE", "6": "LIB", "7": "LA&C" } }, "A": { 1: { "1": "BCME", "2": "LA&C", "3": "CE", "4": "CHE", "5": "IP", "6": "HWYS", "7": "LIB" }, 2: { "1": "CHE", "2": "CE", "3": "LA&C", "4": "BCME", "5": "HWYS", "6": "IP", "7": "SPORTS" }, 3: { "1": "LA&C", "2": "BCME", "3": "IP", "4": "CE", "5": "CHE", "6": "LIB", "7": "COUN" }, 4: { "1": "IP", "2": "CHE", "3": "BCME", "4": "LA&C", "5": "CE", "6": "HWYS", "7": "SPORTS" }, 5: { "1": "CE", "2": "HWYS", "3": "CHE", "4": "IP", "5": "BCME", "6": "LA&C", "7": "LIB" }, 6: { "1": "HWYS", "2": "IP", "3": "CE", "4": "CHE", "5": "LA&C", "6": "BCME", "7": "SPORTS" } }, "B": { 1: { "1": "CHE", "2": "CE", "3": "IP", "4": "BCME", "5": "LA&C", "6": "LIB", "7": "HWYS" }, 2: { "1": "LA&C", "2": "BCME", "3": "CHE", "4": "IP", "5": "CE", "6": "HWYS", "7": "SPORTS" }, 3: { "1": "BCME", "2": "CHE", "3": "LA&C", "4": "IP", "5": "HWYS", "6": "CE", "7": "LIB" }, 4: { "1": "CE", "2": "IP", "3": "HWYS", "4": "CHE", "5": "LA&C", "6": "BCME", "7": "SPORTS" }, 5: { "1": "IP", "2": "LA&C", "3": "BCME", "4": "CE", "5": "CHE", "6": "HWYS", "7": "COUN" }, 6: { "1": "HWYS", "2": "CHE", "3": "IP", "4": "LA&C", "5": "BCME", "6": "CE", "7": "SPORTS" } }, "C": { 1: { "1": "IP", "2": "HWYS", "3": "BCME", "4": "CE", "5": "CHE", "6": "LA&C", "7": "LIB" }, 2: { "1": "BCME", "2": "IP", "3": "HWYS", "4": "CHE", "5": "LA&C", "6": "CE", "7": "SPORTS" }, 3: { "1": "CHE", "2": "CE", "3": "IP", "4": "BCME", "5": "LA&C", "6": "HWYS", "7": "COUN" }, 4: { "1": "LA&C", "2": "BCME", "3": "CE", "4": "IP", "5": "HWYS", "6": "CHE", "7": "SPORTS" }, 5: { "1": "HWYS", "2": "CHE", "3": "LA&C", "4": "CE", "5": "IP", "6": "BCME", "7": "LIB" }, 6: { "1": "CE", "2": "LA&C", "3": "CHE", "4": "HWYS", "5": "IP", "6": "BCME", "7": "SPORTS" } } },
            "3": { 
                "A": { 1: { "1": "CN", "2": "WT", "3": "FLAT", "4": "ML", "5": "CD", "6": "AI", "7": "STM" }, 2: { "1": "WT", "2": "CN", "3": "ML", "4": "CD", "5": "FLAT", "6": "AI", "7": "LIB" }, 3: { "1": "FLAT", "2": "ML", "3": "CD", "4": "CN", "5": "WT", "6": "AI", "7": "SPORTS" }, 4: { "1": "ML", "2": "CD", "3": "AI", "4": "WT", "5": "CN", "6": "FLAT", "7": "COUN" }, 5: { "1": "CD", "2": "AI", "3": "WT", "4": "CN", "5": "ML", "6": "FLAT", "7": "LIB" }, 6: { "1": "AI", "2": "STM", "3": "CN", "4": "WT", "5": "ML", "6": "CD", "7": "SPORTS" } },
                "B": { 1: { "1": "WT", "2": "FLAT", "3": "ML", "4": "CD", "5": "AI", "6": "CN", "7": "STM" }, 2: { "1": "FLAT", "2": "ML", "3": "CD", "4": "AI", "5": "CN", "6": "WT", "7": "LIB" }, 3: { "1": "ML", "2": "CD", "3": "AI", "4": "CN", "5": "WT", "6": "FLAT", "7": "SPORTS" }, 4: { "1": "CD", "2": "AI", "3": "CN", "4": "WT", "5": "FLAT", "6": "ML", "7": "COUN" }, 5: { "1": "AI", "2": "CN", "3": "WT", "4": "FLAT", "5": "ML", "6": "CD", "7": "LIB" }, 6: { "1": "CN", "2": "WT", "3": "FLAT", "4": "ML", "5": "CD", "6": "AI", "7": "SPORTS" } },
                "C": { 1: { "1": "ML", "2": "CD", "3": "AI", "4": "CN", "5": "WT", "6": "FLAT", "7": "STM" }, 2: { "1": "CD", "2": "AI", "3": "CN", "4": "WT", "5": "FLAT", "6": "ML", "7": "LIB" }, 3: { "1": "AI", "2": "CN", "3": "WT", "4": "FLAT", "5": "ML", "6": "CD", "7": "SPORTS" }, 4: { "1": "CN", "2": "WT", "3": "FLAT", "4": "ML", "5": "CD", "6": "AI", "7": "COUN" }, 5: { "1": "WT", "2": "FLAT", "3": "ML", "4": "CD", "5": "AI", "6": "CN", "7": "LIB" }, 6: { "1": "FLAT", "2": "ML", "3": "CD", "4": "AI", "5": "CN", "6": "WT", "7": "SPORTS" } },
                "D": { 1: { "1": "AI", "2": "CN", "3": "WT", "4": "FLAT", "5": "ML", "6": "CD", "7": "STM" }, 2: { "1": "CN", "2": "WT", "3": "FLAT", "4": "ML", "5": "CD", "6": "AI", "7": "LIB" }, 3: { "1": "WT", "2": "FLAT", "3": "ML", "4": "CD", "5": "AI", "6": "CN", "7": "SPORTS" }, 4: { "1": "FLAT", "2": "ML", "3": "CD", "4": "AI", "5": "CN", "6": "WT", "7": "COUN" }, 5: { "1": "ML", "2": "CD", "3": "AI", "4": "CN", "5": "WT", "6": "FLAT", "7": "LIB" }, 6: { "1": "CD", "2": "AI", "3": "CN", "4": "WT", "5": "FLAT", "6": "ML", "7": "SPORTS" } }
            },
            "4": { 
                "A": { 1: { "1": "CNS", "2": "CC", "3": "BDA", "4": "DL", "5": "PROJECT", "6": "PROJECT", "7": "PROJECT" }, 2: { "1": "CC", "2": "BDA", "3": "DL", "4": "CNS", "5": "PROJECT", "6": "PROJECT", "7": "PROJECT" }, 3: { "1": "BDA", "2": "DL", "3": "CNS", "4": "CC", "5": "LIB", "6": "SEMINAR", "7": "SEMINAR" }, 4: { "1": "DL", "2": "CNS", "3": "CC", "4": "BDA", "5": "SPORTS", "6": "COUN", "7": "LIB" }, 5: { "1": "CNS", "2": "CC", "3": "BDA", "4": "DL", "5": "SEMINAR", "6": "SEMINAR", "7": "SEMINAR" }, 6: { "1": "CC", "2": "BDA", "3": "DL", "4": "CNS", "5": "PROJECT", "6": "PROJECT", "7": "PROJECT" } },
                "B": { 1: { "1": "CC", "2": "BDA", "3": "DL", "4": "CNS", "5": "PROJECT", "6": "PROJECT", "7": "PROJECT" }, 2: { "1": "BDA", "2": "DL", "3": "CNS", "4": "CC", "5": "PROJECT", "6": "PROJECT", "7": "PROJECT" }, 3: { "1": "DL", "2": "CNS", "3": "CC", "4": "BDA", "5": "LIB", "6": "SEMINAR", "7": "SEMINAR" }, 4: { "1": "CNS", "2": "CC", "3": "BDA", "4": "DL", "5": "SPORTS", "6": "COUN", "7": "LIB" }, 5: { "1": "CC", "2": "BDA", "3": "DL", "4": "CNS", "5": "SEMINAR", "6": "SEMINAR", "7": "SEMINAR" }, 6: { "1": "BDA", "2": "DL", "3": "CNS", "4": "CC", "5": "PROJECT", "6": "PROJECT", "7": "PROJECT" } },
                "C": { 1: { "1": "BDA", "2": "DL", "3": "CNS", "4": "CC", "5": "PROJECT", "6": "PROJECT", "7": "PROJECT" }, 2: { "1": "DL", "2": "CNS", "3": "CC", "4": "BDA", "5": "PROJECT", "6": "PROJECT", "7": "PROJECT" }, 3: { "1": "CNS", "2": "CC", "3": "BDA", "4": "DL", "5": "LIB", "6": "SEMINAR", "7": "SEMINAR" }, 4: { "1": "CC", "2": "BDA", "3": "DL", "4": "CNS", "5": "SPORTS", "6": "COUN", "7": "LIB" }, 5: { "1": "BDA", "2": "DL", "3": "CNS", "4": "CC", "5": "SEMINAR", "6": "SEMINAR", "7": "SEMINAR" }, 6: { "1": "DL", "2": "CNS", "3": "CC", "4": "BDA", "5": "PROJECT", "6": "PROJECT", "7": "PROJECT" } },
                "D": { 1: { "1": "DL", "2": "CNS", "3": "CC", "4": "BDA", "5": "PROJECT", "6": "PROJECT", "7": "PROJECT" }, 2: { "1": "CNS", "2": "CC", "3": "BDA", "4": "DL", "5": "PROJECT", "6": "PROJECT", "7": "PROJECT" }, 3: { "1": "CC", "2": "BDA", "3": "DL", "4": "CNS", "5": "LIB", "6": "SEMINAR", "7": "SEMINAR" }, 4: { "1": "BDA", "2": "DL", "3": "CNS", "4": "CC", "5": "SPORTS", "6": "COUN", "7": "LIB" }, 5: { "1": "DL", "2": "CNS", "3": "CC", "4": "BDA", "5": "SEMINAR", "6": "SEMINAR", "7": "SEMINAR" }, 6: { "1": "CNS", "2": "CC", "3": "BDA", "4": "DL", "5": "PROJECT", "6": "PROJECT", "7": "PROJECT" } }
            }
        };

        // --- TIMETABLE MODAL LOGIC ---
        function openTimetable() {
            document.getElementById('ttModal').style.display = 'flex';
            renderTimetable('1', document.querySelector('.tt-btn.active')); // Default load 1st year
        }
        function closeTimetable() { document.getElementById('ttModal').style.display = 'none'; }

        function renderTimetable(year, btn) {
            document.querySelectorAll('.tt-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            
            const container = document.getElementById('ttBody');
            container.innerHTML = "";
            const days = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
            const sections = ["A", "B", "C", "D"];

            sections.forEach(section => {
                const title = document.createElement('div');
                title.className = 'tt-section-title';
                title.innerText = `Section ${section}`;
                container.appendChild(title);

                const table = document.createElement('table');
                table.className = 'tt-grid';
                let html = `<thead><tr><th>Day</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th></tr></thead><tbody>`;
                
                for(let i=1; i<=6; i++) { // Days 1-6
                    let row = `<tr><td>${days[i-1]}</td>`;
                    for(let p=1; p<=7; p++) {
                        let sub = "---";
                        if(timeTables[year] && timeTables[year][section] && timeTables[year][section][i]) {
                            sub = timeTables[year][section][i][p] || "---";
                        }
                        row += `<td>${sub}</td>`;
                    }
                    row += `</tr>`;
                    html += row;
                }
                html += `</tbody>`;
                table.innerHTML = html;
                container.appendChild(table);
            });
        }

        // --- FIREBASE LOGIC ---
        let currentUserData = null;
        
        auth.onAuthStateChanged(user => {
            if(user) {
                db.collection("users").doc(user.uid).get().then(doc => {
                    if(doc.exists && doc.data().role === 'student') {
                        currentUserData = doc.data();
                        currentUserData.id = doc.id;
                        
                        // FILL PROFILE
                        document.getElementById('sProfileName').innerText = currentUserData.name || "Student";
                        document.getElementById('sProfileEmail').innerText = currentUserData.email;
                        document.getElementById('sProfileRoll').innerText = currentUserData.rollNo || "---";
                        document.getElementById('sProfileYear').innerText = currentUserData.year ? currentUserData.year + " Year" : "---";
                        document.getElementById('sProfileSection').innerText = "CSE - " + (currentUserData.section || "A");
                        document.getElementById('sProfileInitial').innerText = (currentUserData.name || "S").charAt(0).toUpperCase();

                        loadStats();
                        updateNextClassWidget(); // NEW
                        loadMyLeaves();
                    } else {
                        window.location.href = 'index.html';
                    }
                });
            } else window.location.href = 'index.html';
        });

        function loadStats() {
            const att = currentUserData.attendance || [];
            const total = att.length;
            const present = att.filter(r => r.status === 'Present').length;
            
            let percent = total === 0 ? 0 : Math.round((present / total) * 100);
            
            // Render Progress
            document.getElementById('percentText').innerText = percent + "%";
            document.getElementById('daysAttended').innerText = `${present}/${total} Classes`;
            document.getElementById('progressBar').style.width = percent + "%";
            
            const card = document.getElementById('progressCard');
            const msg = document.getElementById('statusMsg');
            
            if(percent < 75) {
                card.classList.remove('safe-zone'); card.classList.add('danger-zone');
                msg.innerText = "Warning: Low Attendance!";
            } else {
                card.classList.remove('danger-zone'); card.classList.add('safe-zone');
                msg.innerText = "Great job! Safe zone.";
            }

            // Render Modules
            renderSubjectStats(att); // NEW
            renderCalendarWidget(att); // NEW

            // Render History (Existing)
            const list = document.getElementById('historyList');
            list.innerHTML = "";
            if(total === 0) { list.innerHTML = "<p style='padding:20px; text-align:center; color:#666'>No attendance records yet.</p>"; return; }
            
            att.slice().reverse().forEach(r => {
                const color = r.status === 'Present' ? '#30d158' : '#ff453a';
                const div = document.createElement('div');
                div.className = 'row';
                div.innerHTML = `
                    <div class="col">
    ${r.date}
    <span style="font-size:12px; color:#888;">
        â€¢ Period ${r.period || '-'} (${r.subject || 'Gen'})
    </span>
</div>

                    <div class="col end"><span style="color:${color}; font-weight:600;">${r.status}</span></div>
                `;
                list.appendChild(div);
            });
        }

        // --- NEW: SUBJECT ANALYTICS LOGIC ---
        function renderSubjectStats(att) {
            const container = document.getElementById('subjectGrid');
            container.innerHTML = "";
            
            if(att.length === 0) { container.innerHTML = "<p>No data available</p>"; return; }

            // Group by Subject
            const subjects = {};
            att.forEach(r => {
                const sub = r.subject || "General";
                if(!subjects[sub]) subjects[sub] = { total: 0, present: 0 };
                subjects[sub].total++;
                if(r.status === 'Present') subjects[sub].present++;
            });

            // Generate Bars
            Object.keys(subjects).forEach(sub => {
                const data = subjects[sub];
                const pct = Math.round((data.present / data.total) * 100);
                const color = pct < 75 ? "#ff453a" : "#bf5af2"; // Red if low, Purple if safe

                const div = document.createElement('div');
                div.className = 'subject-card';
                div.innerHTML = `
                    <span class="sub-name">${sub}</span>
                    <div class="sub-bar-bg">
                        <div class="sub-bar-fill" style="width:${pct}%; background:${color};"></div>
                    </div>
                    <div class="sub-stats">
                        <span>${pct}%</span>
                        <span>${data.present}/${data.total}</span>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // --- NEW: CALENDAR WIDGET LOGIC ---
        function renderCalendarWidget(att) {
            const container = document.getElementById('calGrid');
            container.innerHTML = "";
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            
            // Set Header
            document.getElementById('calMonthYear').innerText = now.toLocaleString('default', { month: 'long', year: 'numeric' });

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startDay = new Date(year, month, 1).getDay(); // 0 = Sun

            // Header Row (S M T W T F S)
            const weekDays = ["S", "M", "T", "W", "T", "F", "S"];
            weekDays.forEach(d => {
                const div = document.createElement('div');
                div.className = 'cal-day cal-header';
                div.innerText = d;
                container.appendChild(div);
            });

            // Empty slots for previous month
            for(let i=0; i<startDay; i++) {
                const div = document.createElement('div');
                div.className = 'cal-day';
                container.appendChild(div);
            }

            // Day Cells
            for(let i=1; i<=daysInMonth; i++) {
                const div = document.createElement('div');
                div.className = 'cal-day';
                div.innerText = i;

                // Format Date String: YYYY-MM-DD (e.g., 2026-01-05)
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                
                // Check if attendance exists for this day
                // We check if ANY record for this day is present/absent
                const records = att.filter(r => r.date === dateStr);
                
                if(records.length > 0) {
                    const dot = document.createElement('div');
                    dot.className = 'cal-dot';
                    // If at least one 'Present', mark green. Else red.
                    const isPresent = records.some(r => r.status === 'Present');
                    dot.classList.add(isPresent ? 'dot-green' : 'dot-red');
                    div.appendChild(dot);
                }

                container.appendChild(div);
            }
        }

        // --- NEW: UP NEXT WIDGET LOGIC ---
        function updateNextClassWidget() {
            const now = new Date();
            const dayMap = [7, 1, 2, 3, 4, 5, 6]; // Sun=0 -> 7 (No class), Mon=1
            const todayIdx = dayMap[now.getDay()];
            
            // Get Current Student's Year & Section
            const year = currentUserData.year || "2"; 
            const sec = currentUserData.section || "A";

            // If Sunday, Relax
            if(todayIdx === 7) {
                document.getElementById('nextClassName').innerText = "Holiday";
                document.getElementById('nextClassTime').innerText = "--";
                return;
            }

            // Find Next Period
            // Periods: 1(09:00), 2(09:50), 3(11:00)... Simple logic for demo
            // We assume simple 1-hour slots for the demo widget
            const currentHour = now.getHours();
            let period = 1;
            let timeLabel = "09:00";

            if(currentHour < 9) { period = 1; timeLabel = "09:00"; }
            else if(currentHour < 10) { period = 2; timeLabel = "09:50"; }
            else if(currentHour < 11) { period = 3; timeLabel = "11:00"; }
            else if(currentHour < 12) { period = 4; timeLabel = "11:50"; }
            else if(currentHour < 14) { period = 5; timeLabel = "01:40"; }
            else { 
                document.getElementById('nextClassName').innerText = "Classes Over"; 
                document.getElementById('nextClassTime').innerText = "Relax";
                return; 
            }

            // Fetch Subject from TimeTable Object
            let subject = "Free Period";
            if(timeTables[year] && timeTables[year][sec] && timeTables[year][sec][todayIdx]) {
                subject = timeTables[year][sec][todayIdx][period] || "Free";
            }

            document.getElementById('nextClassName').innerText = subject;
            document.getElementById('nextClassTime').innerText = timeLabel;
        }

        function applyLeave() {
            const date = document.getElementById('leaveDate').value;
            const reason = document.getElementById('leaveReason').value;
            
            if(!reason) { alert("Please enter a reason"); return; }
            
            db.collection("leaves").add({
                studentId: auth.currentUser.uid,
                studentName: currentUserData.name,
                date: date,
                reason: reason,
                status: 'Pending',
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                showToast("Leave Request Sent");
                document.getElementById('leaveReason').value = ""; // Clear input
            });
        }

        function loadMyLeaves() {
            db.collection("leaves")
                .where("studentId", "==", auth.currentUser.uid)
                .orderBy("timestamp", "desc")
                .onSnapshot(snap => {
                    const list = document.getElementById('myLeaveList');
                    list.innerHTML = "";
                    if(snap.empty) { list.innerHTML = "<p style='padding:20px; text-align:center; color:#666'>No requests found.</p>"; return; }
                    
                    snap.forEach(doc => {
                        const r = doc.data();
                        const div = document.createElement('div');
                        div.className = 'row';
                        div.innerHTML = `
                            <div class="col">${r.date}</div>
                            <div class="col" style="color:#aaa;">${r.reason}</div>
                            <div class="col end"><span class="badge status-${r.status}">${r.status}</span></div>
                        `;
                        list.appendChild(div);
                    });
                });
        }
    </script>
</body>
</html>